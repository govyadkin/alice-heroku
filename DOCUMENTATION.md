# Как создать навык?

### Что содержится в `main.cpp`?
Главная функция программы содержит в себе всего четыре строки:

```
int main() {
  Skill s;
  s.SetCallback(buy_elephant_callback);
  s.Run();
  return 0;
}
```

* В первой из них мы создаем экземпляр класса `Skill`. С помощью него будет осуществляться создание вашего навыка,
установка главной функции для обработки запросов, осуществляющей взаимодействие с пользователем, активизация сервера.

* Метод `void SetCallback(std::function<void(const Alice::Request& request, Alice::Response& response)>)` устанавливает
вашу функцию `callback`в качестве функции, которая будет определять взаимодействие с пользователем. `Callback` - это
реализованная вами функция, в которой вы занимаетесь обработкой запросов, приходящих от `Алисы` на сервер, и формированием
ответов. Следует отметить, что название функции `callback` может быть абсолютно любым, удобным вам. В нашем примере
мы называем её `buy_elephant_callback`. Установка происходит следующим образом:

```
  Skill s;
  s.SetCallback(buy_elephant_callback);
```

* Метод `void Run()` запускает прослушивание на сервере, ожидающем сообщения от `Алисы`, и при его получении передает
запрос в функцию `callback`, где вы обрабатываете определенные параметры пользовательского запроса и в зависимости от них
формируете ответ, который сервер отправляет `Алисе`.

# Request
Какие- либо действия пользователя или начало диалога (второе иногда, в зависимости от логики навыка) `Алиса` отправляет
серверу `Request`(запрос). Он приходит на сервер в формате `Json`. Для облегчения задачи парсинга (и, как следствие, для
обработки запроса) наша библиотека предусматривает следующие методы:

* Конструктор самого класса `Request`. Параметр - Json-строка, полученная от Алисы.

```Alice::Request request(const char[])```

Он вызывается при запуске тестрирования навыка самостоятельно, однако нижепреведенный пример демонстрирует, как вызвать его
в пользовательской функции. Для разработки навыка этого делать не нужно, пользовательская функция `callback` уже принимает
в качестве параметра готовый объект `Alice::Request& request`.

```
const char data[] = R"({
      "meta": {
        "locale": "ru-RU",
        "timezone": "Europe/Moscow",
        "client_id": "ru.yandex.searchplugin/5.80"
      },
      "request": {
        "command": "hello my friend",
        "original_utterance": "hello my friend",
        "type": "SimpleUtterance",
        "markup": {
          "dangerous_context": true
        },
        "payload": {}
      },
      "session": {
        "new": true,
        "message_id": 4,
        "session_id": "2eac4854-fce721f3-b845abba-20d60",
        "skill_id": "3ad36498-f5rd-4079-a14b-788652932056",
        "user_id": "AC9WC3DF6FCE052E45A4566A48E6B7193774B84814CE49A922E163B8B29881DC"
      },
      "version": "1.0"
    })";
    Alice::Request request(data);
```
* Как же получить доступ к полям `Alice::Request& request`? В соответсвии с документацией, представленной по данной [ссылке,](https://tech.yandex.ru/dialogs/alice/doc/protocol-docpage/)
`Request` имеет четыре основные составляющие - `Meta`, `Session`, `Version` и поле, названное так же, как и весь запрос в целом -
`Request`.
* Доступ к `Meta` вы можете получить, создав экземпляр класса Alice::Meta, конструктор которого в качестве параметра принимает
Alice::Request:

```
  const auto& meta = request.Meta();
```
* `Meta` содержит в себе данные, представленные в виде строк (`Locale`, `Timezone`, `ClientId`). Для получения информации пользуемся
соответствующими методами, возвращающими в качестве результата тип `std::string`:

```
std::string locale = meta.Locale();
std::string timezone = meta.Timezone();
std::string client_id = meta.ClientId();
```
* Аналогична ситуация с `Session`:
Конструктор:

```
const auto& session = request.Session();
```
* `Session` содержит следующие данные: IsNew(тип bool), MessageId (тип std::string), SessionId (тип std::string),
SkillId (тип std::string), UserId (тип std::string). Соответсвенно, существуют методы, позволяющие получить значение
этих полей запроса. Приводим пример их использования:

```
bool isnew = session.IsNew();
std::string messageid = session.MessageId();
std::string sessionid = session.SessionId();
std::string skillid = session.SkillId();
std::string userid = session.MessageId();
```

Данные, хранящиеся в `Session` и `Meta`, зачастую являются служебными и не несут важной для разработчика навыка инфрмации.

Теперь приступим к описанию доступа к действительно важным полям объекта `Request`.

* `std::string Command()` - метод класса `Request`, который возвращает строку, содержащую запрос, который был передан вместе с командой
активации навыка. Пример использования:

```
std::string сommand = request.Command();
```

* `std::string OriginalUtterance()` - метод класса `Request`, который возвращает строку, содержащую полный текст пользовательского запроса,
максимум 1024 символа. Подробнее о том, в чем разница между `std::string Command()` и `std::string OriginalUtterance()`, читайте
в документации `Яндекс.Диалогов`, ссылка на которую уже была предоставлена выше. Пример использования:

```
std::string originalutterance = request.OriginalUtterance();
```
* `Alice::Request::Type RequestType()` - метод класса `Request`, который возвращает тип ввода. Возможные значения:
1) "SimpleUtterance" — голосовой ввод;
2) "ButtonPressed" — нажатие кнопки.
Если пользователь нажал на кнопку, то `Request` будет содержать поле `RequestType` со значением
`Alice::Request::Type::ButtonPressed`, в противном случае - `Alice::Request::Type::SimpleUtterance`.
Пример использоваия:

```
Alice::Request::Type type = request.RequestType();
```

* `bool IsDangerousContext()` - метод класса `Request`, который возвращает признак реплики, содержащей криминальный подтекст
(самоубийство, разжигание ненависти, угрозы). Возможно только значение true. Если признак не применим, это свойство не включается
в ответ. Пример использования :

```
bool dangerous = request.IsDangerousContext();
```

* `nlohmann::json Payload()` - метод класса `Request`, который возвращает `JSON`, полученный с нажатой кнопкой от обработчика навыка
(в ответе на предыдущий запрос). Для того чтобы работать со строкой, а не с `nlohmann::json`,нужно применитть к возвращенному
значению метод `dump()`, преобразующий `JSON` в `std::string`. Пример:

```
std::string payload = request.Payload().dump();
```
* `request.Version()` - метод класса `Request`, который возвращает строку, содержащую информацию о версии протокола. Значение данного
поля в текущий момент времени - "1.0". Пример использования :

```
std::string version = request.Version();
```
Значение данного поля несет в себе служебную информацию и не представляет интереса для разработчика навыка,
однако наша библиотека позволяет получить полный доступ к данным запроса.

# Response

Обработав информацию, содержащуюся в запросе, пользовательской функции `callback` необходимо отправить серверу ответ. Ответ
также представляет из себя `JSON`-строку, однако наша библиотека позволяет автору навыка не заниматься самостоятельным
формированием строки ответа, а сосредоточиться лишь на информации, включенной в `Response`.
Ответом является объект класса `Alice::Response`, передаваемый вторым параметром в `callback`. Рассмотрим подробнее
методы, предусмотренные для составления ответа.

### Добавление текста
* Для того чтобы `Алиса` ответила пользователю сообщением, вам необходимо включить его в `Response`. Метод, позволяющий делать
это и пример его использования:

```
response.SetText("Hi, dear friend");
```
Параметры метода - строка (`std::string`).

* Метод `SetText(std::string)` устанавливает текст, который `Алиса` отправляет пользователю, в формате TTS (text-to-speech),
 максимум 1024 символа. Пример:

```
response.SetTts("Hi, dear friend");
```

* Метод `SetEndSession(bool)` устанавливает признак конца диалога. Если диалог будет закончен и данный ответ `Алисы` - последний,
то в параметры необходимо передать `true`, иначе - `false`. Использование:

```
response.SetEndSession(true);
```

### Добавление кнопки в навык

`Алиса` может отвечать на запрос пользователя не только текстовыми сообщениями, но и отправлять ему кнопки. Кнопки можно использовать
как релевантные ответу ссылки или подсказки для продолжения разговора. Для добавления кнопки в навык необходимо:

а) Создать объект класса `Alice::Button`, конструктор которого содержит следующие параметры:

      1)Строку `std::string`, представляющую из себя текст, обязательный для каждой кнопки;
      2) Произвольный `JSON`, который `Яндекс.Диалоги` должны отправить серверу, если данная кнопка будет нажата;
      3) Строку `std::string`, представляющую из себя URL, который должна открывать кнопка при её нажатии. Наша библиотека поддерживает
      конструктор без данного параметра (используется в случае, если кнопка при её нажатии не должна открывать веб - страницу);
      4) Переменную типа `bool` - признак того, что кнопку нужно убрать после следующей реплики пользователя. Допустимые значения: false —
      кнопка должна оставаться активной (значение по умолчанию), true - кнопку нужно скрывать после нажатия.

б) Поскольку кнопок может быть несколько, необходимо добавить созданную в первом пункте кнопку в массив, содержащийся в экземпляре класса ответа,
с помощью метода `PushButton(Alice::Button)`Пункты а) и б) необходимо повторять для каждой добавляемой вами в ответ кнопки.

Пример создания и добавления кнопки:

```
 Alice::Button button("Print on button", {"json"}, "http://example.com/", true);
 response.PushButton(button);
```

### Добавление карточки (изображения) в навык

`Алиса` может отправлять в ответ собеседнику изображение. Пока наша библиотека поддерживает добавление только одной картинки.
Для полного понимания того, как это сделать, необходимо ознакомиться с интсрукцией по запуску навыка, размещенной в данном
репозитории. Описывем необходимые шаги:

а) Создаем объект класса `Alice::ButtonPicture`, отвечающий за поведение картинки при нажатии на неё. Конструктор данного
класса принимает следующие необходимые параметры:

     1) Строку `std::string`, содержащую информацию о тексте, который будет отправлен навыку по нажатию на изображение в качестве
     команды пользователя.
     2) Строку `std::string`, задающую URL, который должен открываться после нажатия на изображение
     3) Произвольный `JSON`, который `Яндекс.Диалоги` должны отправить серверу, если пользователь нажмет на изображение.

б) Создаем экземпляр класса `Alice::Card`, определяющий все параметры отображения картинки. Параметры конструктора:

     1) Строка `std::string`, обозначающая тип карточки. Поддерживаемые значения на данный момент времени:
     "BigImage" — одно изображение.
     2) Строка, `std::string` являющаяся идентификатором изображения, который возвращается в ответ на запрос загрузки. О том,
     как отправить запрос загрузки и получить данный идентификатор, читайте в инструкции по запуску пробного навыка.
     3) Строка `std::string`, содержащая заголовок для изображения.
     4) Строка `std::string`, определяющая описание изображения.
     5) Экземпляр класса `Alice::ButtonPicture`, созданный в первом пункте.

в) Вызываем метод `SetCard(Alice::card)`, который добавит нашу кнопку в ответ.
Пример создания карточки для навыка:

```
Alice::ButtonPicture button("Print on button", "http://example.com/", {"json"});
Alice::Card card("BigImage", "1027858/46r960da47f60207e924",
                 "Title for image", "Description of image", button);
response.SetCard(card);
```
### Общие замечания

* Не используйте в качестве произвольного `JSON` (как при создании экземпляра `Alice::ButtonPicture`, так и при
создании объекта  `Alice::Button`) пустой `JSON` вида `{}`. Это может привести к нерпедвиденным ошибкам.

* `Response` так же, как и `Request`, содержит данные о сессии, однако они заполняются библиотекой автоматически.

Желаем успехов в создании навыков!
